<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Aì–‘</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<style>
  #ipGood div, #ipBad div { text-align:left; }
  button.replyBtn { margin-left:5px; }
</style>
</head>
<body>
<div class="center-text">
  <p>
    <span class="clickable" onclick="toggleNote('noteA','top')">Aì–‘</span>ì€
    <span class="clickable" onclick="toggleNote('noteEo','top')"> ì–´ë–¤</span>
    <span class="clickable" onclick="toggleNote('noteS','top')"> ì‚¬ëŒ</span><span class="clickable" onclick="toggleNote('noteIp','top')">ì…ë‹ˆê¹Œ?</span>
  </p>

  <div id="noteA" class="note" data-group="top" style="display:none;">
    <span class="pc-text">
      <span class="clickable" onclick="toggleNote('noteGood')">ì¢‹ì€ë³„</span>ê³¼
      ---------------------------------------------------------------------------------
      <span class="clickable" onclick="toggleNote('noteBad')">ë‚˜ìœë³„</span> ì‚¬ì´<br>
      ì–´ë–¤ ì¡°ì€ë³„
    </span>

    <span class="mobile-text">
      <span class="clickable" onclick="toggleNote('noteGood')">ì¢‹ì€ë³„</span>ê³¼
      -------------------------------
      <span class="clickable" onclick="toggleNote('noteBad')">ë‚˜ìœë³„</span> ì‚¬ì´<br>
       ì–´ë–¤ ì¡°ì€ë³„
    </span>

    <div class="two-column">
      <div class="column note" id="noteGood">
        <h4>ì¢‹ì€ë³„ì— ëŒ€í•œ ë¯¸ë‹´</h4>
        <textarea id="goodText" placeholder="ì¢‹ì€ë³„ì— ëŒ€í•œ ë¯¸ë‹´ì„ ì ì–´ì£¼ì„¸ìš”"
          style="width:100%; height:80px;"></textarea><br>
        <button onclick="saveGood()">ì €ì¥</button>
        <div id="goodSaved" style="white-space:pre-wrap;"></div>
      </div>

      <div class="column note" id="noteBad">
        <h4>ë‚˜ìœë³„ì— ëŒ€í•œ ìŒëª¨ë¡ </h4>
        <textarea id="badText" placeholder="ë‚˜ìœë³„ì— ëŒ€í•œ ìŒëª¨ë¡ ì„ ì ì–´ì£¼ì„¸ìš”"
          style="width:100%; height:80px;"></textarea><br>
        <button onclick="saveBad()">ì €ì¥</button>
        <div id="badSaved" style="white-space:pre-wrap;"></div>
      </div>
    </div>
  </div>

  <div id="noteEo" class="note" data-group="top">
    <p>ê³§ Aì–‘ì˜ ì…ì¥ë°œí‘œê°€ ìˆê² ìŠµë‹ˆë‹¤...</p>
  </div>

  <div id="noteS" class="note" data-group="top">
    Aì–‘ì˜ ë§¤ë ¥ì´ ë¬´ì—‡ì¸ê°€ìš”?<br>
    <textarea id="noteSText" placeholder="ì†”ì§í•˜ê²Œã…‹ã…‹"
      style="width:30%; height:80px;"></textarea><br>
    <button onclick="saveNoteS()">ì €ì¥</button>
  </div>

  <div id="noteIp" class="note" data-group="top" style="position:relative; min-height:300px;">
    <p>Aì–‘ì„ ë‘ê³  ë²Œì–´ì§€ëŠ” ê°‘ë¡ ì„ë°•ì— ì°¸ì—¬í•˜ì„¸ìš”</p>
    <div id="ipGood" style="white-space:normal; margin-bottom:15px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="ipBad" style="white-space:normal;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <span id="floatingBad" onclick="goToBad()"
      style="position:absolute; cursor:pointer; color:black; font-weight:bold;">
      ìŒëª¨ë¡  í¼ëœ¨ë¦¬ëŸ¬ ê°€ê¸°
    </span>
    <span id="floatingGood" onclick="goToGood()"
      style="position:absolute; cursor:pointer; color:black; font-weight:bold;">
      ë¯¸ë‹´ í¼ëœ¨ë¦¬ëŸ¬ ê°€ê¸°
    </span>
  </div>
</div>

<script>
function toggleNote(noteId, group) {
  const note = document.getElementById(noteId);
  if (group) {
    document.querySelectorAll(`.note[data-group='${group}']`).forEach(n => {
      if (n.id !== noteId) {
        n.style.display = 'none';
        n.querySelectorAll('.note').forEach(c => c.style.display = 'none');
      }
    });
  }
  note.style.display = (note.style.display === 'block') ? 'none' : 'block';
}
window.toggleNote = toggleNote;

function goToBad() {
  toggleNote('noteA');
  document.getElementById('noteBad').style.display = 'block';
  document.getElementById('noteBad').scrollIntoView({ behavior: 'smooth', block: 'center' });
  document.getElementById('noteIp').style.display = 'none';
}

function goToGood() {
  toggleNote('noteA');
  document.getElementById('noteGood').style.display = 'block';
  document.getElementById('noteGood').scrollIntoView({ behavior: 'smooth', block: 'center' });
  document.getElementById('noteIp').style.display = 'none';
}
window.goToGood = goToGood;

// Floating motion fix
let posX_B = 0, posY_B = 0;
let posX_G = 0, posY_G = 0;
let deltaX_B = 1, deltaY_B = 1;
let deltaX_G = 1, deltaY_G = 0.3;

function initFloatingPositions() {
  const container = document.getElementById('noteIp');
  const floatingBad = document.getElementById('floatingBad');
  const floatingGood = document.getElementById('floatingGood');

  const width = container.clientWidth;
  const height = container.clientHeight;

  posX_B = Math.random() * (width - floatingBad.offsetWidth);
  posY_B = Math.random() * (height - floatingBad.offsetHeight);
  posX_G = Math.random() * (width - floatingGood.offsetWidth);
  posY_G = Math.random() * (height - floatingGood.offsetHeight);

  floatingBad.style.left = posX_B + 'px';
  floatingBad.style.top = posY_B + 'px';
  floatingGood.style.left = posX_G + 'px';
  floatingGood.style.top = posY_G + 'px';

  // start animation
  setInterval(moveFloating, 20);
}

function moveFloating() {
  const container = document.getElementById('noteIp');
  const floatingBad = document.getElementById('floatingBad');
  const floatingGood = document.getElementById('floatingGood');

  const width = container.clientWidth;
  const height = container.clientHeight;

  posX_B += deltaX_B;
  posY_B += deltaY_B;
  if (posX_B <= 0 || posX_B >= width - floatingBad.offsetWidth) deltaX_B *= -1;
  if (posY_B <= 0 || posY_B >= height - floatingBad.offsetHeight) deltaY_B *= -1;
  floatingBad.style.left = posX_B + 'px';
  floatingBad.style.top = posY_B + 'px';

  posX_G += deltaX_G;
  posY_G += deltaY_G;
  if (posX_G <= 0 || posX_G >= width - floatingGood.offsetWidth) deltaX_G *= -1;
  if (posY_G <= 0 || posY_G >= height - floatingGood.offsetHeight) deltaY_G *= -1;
  floatingGood.style.left = posX_G + 'px';
  floatingGood.style.top = posY_G + 'px';
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAOqZpA9JiMQltXNRDqcfCp56EcNshmZkE",
  authDomain: "aaaa-c9d20.firebaseapp.com",
  projectId: "aaaa-c9d20",
  storageBucket: "aaaa-c9d20.firebasestorage.app",
  messagingSenderId: "221373713446",
  appId: "1:221373713446:web:c26d4d7edb50455d4faae7",
  measurementId: "G-L2M1ZFSLVZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function formatDate(date) {
  const y = date.getFullYear().toString().slice(2);
  return `${y}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}:${String(date.getSeconds()).padStart(2,'0')}`;
}

async function renderNotes(containerId, arr) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  arr.forEach((item, idx) => {
    const div = document.createElement('div');
    div.style.marginBottom = '5px';
    div.textContent = `${item.timestamp} ${item.text}`;
    if (containerId === 'ipGood' || containerId === 'ipBad') {
      const replyBtn = document.createElement('button');
      replyBtn.textContent = 'ë‹µê¸€';
      replyBtn.className = 'replyBtn';
      replyBtn.onclick = () => showReplyInput(containerId, idx);
      div.appendChild(replyBtn);
      if (item.replies) {
        item.replies.forEach((r, i) => renderReply(div, r, i + 1));
      }
    }
    container.appendChild(div);
  });
}

function renderReply(parentDiv, replyObj, level) {
  const rDiv = document.createElement('div');
  rDiv.style.marginLeft = `${level * 20}px`;
  rDiv.style.marginTop = '3px';
  rDiv.textContent = `${replyObj.timestamp} ${replyObj.text}`;
  parentDiv.appendChild(rDiv);
}

window.showReplyInput = function (containerId, index) {
  const container = document.getElementById(containerId);
  const parentDiv = container.children[index];
  if (parentDiv.querySelector('input')) return;
  const replyDiv = document.createElement('div');
  replyDiv.style.marginLeft = `20px`;
  replyDiv.innerHTML = `<input type="text" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">`;
  const input = replyDiv.querySelector('input');
  input.addEventListener('keypress', e => {
    if (e.key === 'Enter') saveReply(containerId, index, input.value);
  });
  parentDiv.appendChild(replyDiv);
};

window.saveReply = async function (containerId, index, text) {
  if (!text) return;
  const docName = containerId === 'ipGood' ? 'good' : 'bad';
  const docRef = doc(db, 'notes', docName);
  const docSnap = await getDoc(docRef);
  let arr = docSnap.exists() ? docSnap.data().texts || [] : [];
  if (!arr[index].replies) arr[index].replies = [];
  arr[index].replies.push({ text, timestamp: formatDate(new Date()) });
  await setDoc(docRef, { texts: arr });
  renderNotes(containerId, arr);
};

window.saveGood = async function () {
  const text = document.getElementById("goodText").value;
  if (!text) return;
  const docRef = doc(db, 'notes', 'good');
  const docSnap = await getDoc(docRef);
  let arr = docSnap.exists() ? docSnap.data().texts || [] : [];
  arr.push({ text, timestamp: formatDate(new Date()), replies: [] });
  await setDoc(docRef, { texts: arr });
  renderNotes('goodSaved', arr);
  renderNotes('ipGood', arr);
  document.getElementById("goodText").value = '';
};

window.saveBad = async function () {
  const text = document.getElementById("badText").value;
  if (!text) return;
  const docRef = doc(db, 'notes', 'bad');
  const docSnap = await getDoc(docRef);
  let arr = docSnap.exists() ? docSnap.data().texts || [] : [];
  arr.push({ text, timestamp: formatDate(new Date()), replies: [] });
  await setDoc(docRef, { texts: arr });
  renderNotes('badSaved', arr);
  renderNotes('ipBad', arr);
  document.getElementById("badText").value = '';
};

window.saveNoteS = async function () {
  const text = document.getElementById("noteSText").value;
  if (!text) return;
  const docRef = doc(db, 'notes', 'noteS');
  const docSnap = await getDoc(docRef);
  let arr = docSnap.exists() ? docSnap.data().texts || [] : [];
  arr.push({ text, timestamp: formatDate(new Date()) });
  await setDoc(docRef, { texts: arr });
  document.getElementById("noteSText").value = '';
};

async function loadNotes() {
  const goodSnap = await getDoc(doc(db, 'notes', 'good'));
  if (goodSnap.exists()) {
    const arr = goodSnap.data().texts || [];
    renderNotes('goodSaved', arr);
    renderNotes('ipGood', arr);
  }

  const badSnap = await getDoc(doc(db, 'notes', 'bad'));
  if (badSnap.exists()) {
    const arr = badSnap.data().texts || [];
    renderNotes('badSaved', arr);
    renderNotes('ipBad', arr);
  }

  // ğŸ”¥ floating animation ì‹œì‘ ìœ„ì¹˜ëŠ” ë°ì´í„° ë¡œë”© ëë‚œ ë’¤ì— ì‹¤í–‰
  initFloatingPositions();
}

loadNotes();
</script>

</body>
</html>
